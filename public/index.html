<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic-Oid üé©</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>body { font-family: "Inter", sans-serif; background-color: #0f0a1e; color: #fff; } .font-magic { font-family: "Cinzel", serif; }</style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const compressImage = (file) => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const scale = Math.min(600/img.width, 600/img.height, 1);
                    canvas.width = img.width * scale; canvas.height = img.height * scale;
                    canvas.getContext("2d").drawImage(img,0,0,canvas.width,canvas.height);
                    resolve(canvas.toDataURL("image/jpeg", 0.6));
                }; img.src = e.target.result;
            }; reader.readAsDataURL(file);
        });

        function App() {
            const [mode, setMode] = useState("identify");
            const [image, setImage] = useState(null);
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showQR, setShowQR] = useState(false);
            const [userId, setUserId] = useState("");
            const camRef = useRef(null); const galRef = useRef(null);

            useEffect(() => {
                let id = localStorage.getItem("magic_oid_user");
                if (!id) { id = "magician_" + Math.random().toString(36).substr(2, 9); localStorage.setItem("magic_oid_user", id); }
                setUserId(id);
            }, []);

            const handleAnalyze = async (file) => {
                setLoading(true); setImage(await compressImage(file));
                const endpoint = mode === "roast" ? "/api/roast-magic" : "/api/analyze-magic";
                try {
                    const res = await fetch(endpoint, { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ image: await compressImage(file) }) });
                    const data = await res.json(); setResult(data.analysis || data.roast);
                } catch(e) { alert("Error: " + e.message); }
                setLoading(false);
            };

            const myLink = `https://magicoid.netlify.app?ref=${userId}`;

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    <div className="w-full max-w-md flex justify-between items-center mb-6">
                        <h1 className="font-magic text-xl">üé© Magic-Oid</h1>
                        <button onClick={() => setShowQR(true)} className="bg-white/10 px-3 py-1 rounded-full text-xs flex items-center gap-2 border border-white/20"><span>üéüÔ∏è My Code</span></button>
                    </div>
                    <div className="bg-white/5 p-1 rounded-xl flex w-full max-w-md mb-6">
                        <button onClick={() => { setMode("identify"); setImage(null); }} className={`flex-1 py-3 rounded-lg font-bold transition-all ${mode==="identify"?"bg-purple-900 shadow-lg":"text-gray-400"}`}>üîÆ Identify</button>
                        <button onClick={() => { setMode("roast"); setImage(null); }} className={`flex-1 py-3 rounded-lg font-bold transition-all ${mode==="roast"?"bg-orange-800 shadow-lg":"text-gray-400"}`}>üî• Roast</button>
                    </div>
                    <div className="w-full max-w-md bg-white/5 rounded-2xl p-6 border border-white/10 shadow-2xl backdrop-blur-sm">
                        {!image ? (
                            <div className="text-center py-8">
                                <div className="flex flex-col gap-3">
                                    <button onClick={() => camRef.current.click()} className="bg-purple-600 py-4 rounded-xl font-bold">üì∑ Take Photo</button>
                                    <button onClick={() => galRef.current.click()} className="bg-white/10 py-4 rounded-xl font-bold">üñºÔ∏è Gallery</button>
                                </div>
                                <input type="file" ref={camRef} className="hidden" accept="image/*" capture="environment" onChange={e => handleAnalyze(e.target.files[0])} />
                                <input type="file" ref={galRef} className="hidden" accept="image/*" onChange={e => handleAnalyze(e.target.files[0])} />
                            </div>
                        ) : (
                            <div>
                                <img src={image} className="w-full rounded-xl mb-4" />
                                {loading ? <p className="text-center font-magic animate-pulse">Consulting spirits...</p> : (
                                    <div className="bg-black/30 p-4 rounded-xl whitespace-pre-wrap text-sm">{result}</div>
                                )}
                                <button onClick={() => setImage(null)} className="w-full mt-4 py-3 bg-white/10 rounded-lg">New Scan</button>
                            </div>
                        )}
                    </div>
                    {showQR && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onClick={() => setShowQR(false)}>
                            <div className="bg-white text-black p-6 rounded-2xl text-center w-full max-w-sm" onClick={e => e.stopPropagation()}>
                                <h3 className="font-magic text-2xl font-bold mb-2">Pay It Forward</h3>
                                <p className="text-sm text-gray-600 mb-4">Share this code. When others use it, you earn Kudos!</p>
                                <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${myLink}`} className="mx-auto border-4 border-black mb-4 rounded-lg" />
                                <div className="bg-gray-100 p-2 rounded mb-4 break-all text-xs font-mono">{myLink}</div>
                                <button onClick={() => { navigator.clipboard.writeText(myLink); alert("Link Copied!"); }} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold mb-2">üìã Copy Link</button>
                                <button onClick={() => setShowQR(false)} className="w-full bg-gray-200 text-gray-800 py-3 rounded-xl font-bold">Close</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
</body>
</html>