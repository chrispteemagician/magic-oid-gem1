<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic-Oid - Magic Effect Identification</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    function MagicOid() {
      const [mode, setMode] = useState('identify');
      const [image, setImage] = useState(null);
      const [preview, setPreview] = useState(null);
      const [analysis, setAnalysis] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [showGallery, setShowGallery] = useState(false);
      
      const cameraRef = useRef(null);
      const galleryRef = useRef(null);

      const handleImageChange = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            setError('Image too large. Max 5MB.');
            return;
          }
          setImage(file);
          setPreview(URL.createObjectURL(file));
          setAnalysis('');
          setError('');
        }
      };

      const analyzeImage = async () => {
        if (!image) return;
        setLoading(true);
        setError('');

        try {
          const reader = new FileReader();
          reader.readAsDataURL(image);
          
          reader.onloadend = async () => {
            const base64 = reader.result;
            const endpoint = mode === 'roast' ? '/.netlify/functions/roast' : '/.netlify/functions/analyze';
            
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image: base64 })
            });

            if (!response.ok) throw new Error('Analysis failed');
            const data = await response.json();
            setAnalysis(data.analysis || 'No analysis available');
            
            if (mode === 'roast') {
              saveToGallery(data.analysis);
            }
            setLoading(false);
          };
        } catch (err) {
          setError(err.message || 'Something went wrong');
          setLoading(false);
        }
      };

      const saveToGallery = (roastText) => {
        try {
          const gallery = JSON.parse(localStorage.getItem('roast_gallery') || '[]');
          gallery.unshift({ id: Date.now(), roast: roastText, timestamp: new Date().toISOString() });
          localStorage.setItem('roast_gallery', JSON.stringify(gallery.slice(0, 20)));
        } catch (err) {
          console.error('Save failed:', err);
        }
      };

      const getGallery = () => {
        try {
          return JSON.parse(localStorage.getItem('roast_gallery') || '[]');
        } catch {
          return [];
        }
      };

      const reset = () => {
        setImage(null);
        setPreview(null);
        setAnalysis('');
        setError('');
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-indigo-900 p-4 md:p-8">
          <div className="max-w-4xl mx-auto">
            
            <div className="text-center mb-6">
              <h1 className="text-5xl md:text-6xl font-bold text-white mb-2">ğŸ© Magic-Oid</h1>
              <p className="text-xl text-purple-200">Your Magic Effect Identification Expert</p>
            </div>

            <div className="flex gap-3 justify-center mb-6 flex-wrap">
              <a href="https://buymeacoffee.com/chrispteemagician" target="_blank" className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm">â˜• Coffee</a>
            </div>

            <div className="flex gap-3 justify-center mb-6 flex-wrap">
              <button onClick={() => setMode('identify')} className={`px-6 py-3 rounded-lg font-semibold ${mode === 'identify' ? 'bg-purple-600 text-white' : 'bg-white/20 text-purple-200'}`}>
                ğŸ”® Identify
              </button>
              <button onClick={() => setMode('roast')} className={`px-6 py-3 rounded-lg font-semibold ${mode === 'roast' ? 'bg-gradient-to-r from-orange-500 to-red-600 text-white' : 'bg-white/20 text-purple-200'}`}>
                ğŸ”¥ ROAST
              </button>
              {mode === 'roast' && (
                <button onClick={() => setShowGallery(true)} className="px-6 py-3 rounded-lg font-semibold bg-white/20 text-purple-200">
                  ğŸ­ Gallery
                </button>
              )}
            </div>

            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 md:p-8 mb-6">
              {!preview ? (
                <div className="text-center">
                  <div className={`border-4 border-dashed rounded-xl p-12 mb-6 ${mode === 'roast' ? 'border-orange-400' : 'border-purple-400'}`}>
                    <div className="text-6xl mb-4">{mode === 'roast' ? 'ğŸ”¥ğŸ“¸' : 'ğŸ©ğŸ“¸'}</div>
                    <p className="text-white text-xl mb-2">{mode === 'roast' ? 'Upload a MAGICIAN' : 'Upload a Magic Effect'}</p>
                    <p className="text-purple-300 text-xs mb-8">Max 5MB</p>
                    
                    <div className="flex gap-4 justify-center flex-wrap">
                      <button onClick={() => cameraRef.current?.click()} className="bg-purple-600 text-white px-8 py-4 rounded-lg font-semibold text-lg">
                        ğŸ“· Camera
                      </button>
                      <button onClick={() => galleryRef.current?.click()} className="bg-indigo-600 text-white px-8 py-4 rounded-lg font-semibold text-lg">
                        ğŸ–¼ï¸ Gallery
                      </button>
                    </div>
                  </div>
                  
                  <input ref={cameraRef} type="file" accept="image/*" capture="environment" onChange={handleImageChange} className="hidden" />
                  <input ref={galleryRef} type="file" accept="image/*" onChange={handleImageChange} className="hidden" />
                </div>
              ) : (
                <div>
                  <img src={preview} alt="Preview" className="max-w-full h-auto rounded-lg mx-auto mb-6" style={{ maxHeight: '400px' }} />

                  {!analysis && !loading && (
                    <div className="flex gap-4 justify-center">
                      <button onClick={analyzeImage} className={`px-8 py-4 rounded-lg font-semibold text-lg text-white ${mode === 'roast' ? 'bg-gradient-to-r from-orange-500 to-red-600' : 'bg-gradient-to-r from-purple-600 to-indigo-600'}`}>
                        {mode === 'roast' ? 'ğŸ”¥ ROAST!' : 'ğŸ”® Identify'}
                      </button>
                      <button onClick={reset} className="bg-white/20 text-white px-6 py-4 rounded-lg font-semibold">
                        Try Another
                      </button>
                    </div>
                  )}

                  {loading && (
                    <div className="text-center py-8">
                      <div className="text-2xl font-bold text-white mb-4">
                        {mode === 'roast' ? 'ğŸ”¥ Roasting...' : 'ğŸ”® Analyzing...'}
                      </div>
                    </div>
                  )}

                  {error && (
                    <div className="bg-red-500/20 border border-red-500 text-red-100 rounded-lg p-4 mb-4">
                      {error}
                    </div>
                  )}

                  {analysis && (
                    <div>
                      <div className="bg-white/5 rounded-lg p-6 mb-4">
                        <div className="whitespace-pre-wrap text-white">{analysis}</div>
                      </div>
                      <button onClick={reset} className="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold w-full">
                        {mode === 'roast' ? 'ğŸ”¥ Roast Another' : 'ğŸ© Identify Another'}
                      </button>
                    </div>
                  )}
                </div>
              )}
            </div>

            <div className="text-center text-purple-200 text-sm">
              <p>Built by <strong>Chris P Tee</strong> â€¢ Magic Circle â€¢ 30+ Years</p>
            </div>
          </div>

          {showGallery && (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50">
              <div className="bg-purple-900 rounded-2xl p-8 max-w-4xl w-full">
                <div className="flex justify-between mb-6">
                  <h2 className="text-4xl font-bold text-white">ğŸ­ Rogue's Gallery</h2>
                  <button onClick={() => setShowGallery(false)} className="text-white text-2xl">âœ•</button>
                </div>
                <div className="grid md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                  {getGallery().length === 0 ? (
                    <div className="col-span-2 text-center py-12">
                      <div className="text-6xl mb-4">ğŸ©</div>
                      <p className="text-purple-200">No roasts yet!</p>
                    </div>
                  ) : (
                    getGallery().map((entry) => (
                      <div key={entry.id} className="bg-white/10 rounded-lg p-4">
                        <div className="text-6xl mb-3 text-center">ğŸ©</div>
                        <p className="text-white text-sm italic">"{entry.roast}"</p>
                        <p className="text-purple-300 text-xs mt-2">
                          {new Date(entry.timestamp).toLocaleDateString()}
                        </p>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<MagicOid />, document.getElementById('root'));
  </script>
</body>
</html>
